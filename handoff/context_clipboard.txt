=== SNAPSHOT (кратко) ===
Space Aces  бот для игры Space Aces (аналог DarkOrbit) на Python + OpenCV. Бот использует компьютерное зрение и навигацию по миникарте, чтобы:

фармить мобов и бонус-коробки на дружественных картах (1-1, 1-2, 1-3, 1-4);

безопасно уходить по Flee-протоколу (ShiftACapsLockBV) и отсиживаться в SAFE-зонах у порталов;

переживать смерть, ремонтироваться и выполнять cooldown по картам перед возвратом на более жирные карты.

Архитектура:

vision  захват экрана, ROI, детект:

на миникарте: игрок (перекрёст), красные цели (мобы/NPC/враги), порталы;

на основном экране: мобы (спрайты + имена), бонус-коробки, HUD (HP/Shield, конфиг).

navigation  выбор цели, расчёт точки подлёта (80% до врага от позиции игрока), движение к целям и порталам по миникарте.

FSM  состояния FARMING, FLEEING, IN_SAFE, COOLDOWN, DEAD:

FARMING: цели на миникарте  подлёт  lock по имени моба  стрельба Z/X;

FLEEING: уход при плохом HP/Shield;

IN_SAFE: восстановление в SAFE-зоне;

COOLDOWN: фарм на более безопасных картах после смерти;

DEAD: обработка модалки смерти и ремонт.

controls  ЛКМ по миникарте/игре + клавиши (Z/X, Shift, A, B, V, CapsLock, Space).

tools  roi_calibrator, self-test, утилиты для логов/hand-off.

config/profiles  ROI MAIN/MINIMAP, HSV-профили, ignore-зоны, пороги flee, конфиг порталов.

Процесс разработки:

Короткие итерации.

Все правки кода/конфигов/структуры  только через Codex/код-модель:

ассистент даёт детальные промты;

пользователь передаёт их Codex и запускает команды;

результаты (логи, скрины) возвращаются в чат.

Каждая итерация сопровождается логированием и запуском python run.py --mode test.

Текущее состояние (high-level):

run.py поддерживает режимы:

--mode test (визуальный self-test детекторов);

--mode bot (боевой режим).

Логгер space_aces пишет в logs/space_aces.log.

MINIMAP:

детект красных целей (enemies_mm) по HSV-маске с фильтрами формы и ignore-зонами;

детект порталов по белым маркерам (по техплану, частично реализован);

детектор игрока (player_mm) существует, но даёт нестабильный результат (часто None).

MAIN:

детект имён мобов (строки вида -=[Luminid]=-, .:{Boss Luminid}:.) и преобразование bbox имени в точку клика чуть выше;

детект бонус-коробок;

детект HUD (HP/Shield, конфиг) описан и частично реализован, но ещё не встроен в FSM._sense.

Навигация:

концепция подлёт на 80% по миникарте, затем engage по имени моба реализована частично в navigation.py и FSM, но упирается в нестабильный player_mm и требующую калибровки MINIMAP-ROI.

FSM:

состояния FARMING/FLEEING/IN_SAFE/COOLDOWN/DEAD описаны;

FARMING частично использует детект целей/лейблов, но пока без полноценного цикла движения и атаки;

FLEE/SAFE/COOLDOWN/DEAD в основном на уровне плана и заготовок.

Блокеры:

ROI главного окна и миникарты смещены после экспериментов  возможен эффект экран в экране.

Детектор игрока на миникарте часто возвращает player_mm=None, из-за чего навигация не работает надёжно.

FLEE/SAFE/COOLDOWN и Death/Respawn не доведены до end-to-end сценария в FSM.

Self-test/метрики (Recall/FPR, тайминги) ещё не реализованы.

=== ИТЕРАЦИИ (последние) ===

Итерация 2  2025-11-16  Документация и handoff

Собрали расширенный техплан (исходный PDF + игровые механики + детекторы + Flee/Death).

Зафиксировали архитектуру модулей и формат работы только через Codex.

Подготовили основу для CONTEXT_SNAPSHOT и handoff-формата (snapshot + итерации + next steps).

Итерация 3  2025-11-16  Техплан, механики и handoff-подготовка

Дополнили и подчистили техплан, оформили единый документ space_aces_tech_plan_full.

Обновили CONTEXT_SNAPSHOT под актуальный статус/фокус.

Сформировали этот handoff-пакет для переезда между чатами.

=== NEXT STEPS (для нового чата) ===

Подтвердить, что игра запущена в ожидаемом разрешении/расположении окна.

Через Codex:

найти и запустить tools/roi_calibrator;

перекалибровать ROI MAIN/MINIMAP и сохранить в профиле.

Стабилизировать детектор игрока на миникарте (player_mm):

доработать find_player_crosshair;

добавить хранение последней позиции в FSM.

Включить навигацию в состоянии FARMING:

выбор ближайшей цели по enemies_mm;

подлёт на 80% по миникарте;

после подлёта  поиск имени моба, клик чуть выше, стрельба Z/X.

Подключить HUD (HP/Shield) к FSM._sense и реализовать FLEE/IN_SAFE/COOLDOWN/DEAD.

Начать строить self-test: скриншоты, эталонные ответы, метрики Recall/FPR и тайминги (trace.csv).

=== КЛЮЧЕВЫЕ РЕШЕНИЯ ===

SSOT: техплан + файлы в docs/ + проект в ChatGPT Project  не распылять архитектуру по случайным заметкам.

Навигация: подлёт 80% по миникарте, затем engage по имени моба (fallback  простая стрельба по ближайшей цели).

FLEE/SAFE: пороги по HP/Shield и жёсткий макро ShiftACapsLockBV, затем уход в SAFE-зону.

Death/Respawn: строгая последовательность Бесплатно  ожидание активной кнопки  Отремонтировать  возврат и cooldown.

Публичные интерфейсы модулей не изменяются без явного запроса; любые изменения  через Codex, с логированием и self-test.
