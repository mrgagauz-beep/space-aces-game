<!-- Snapshot update. -->
CONTEXT_SNAPSHOT

Last updated: 2025-11-16

One-liner

Space Aces  бот для фарма и боёв в Space Aces (аналог DarkOrbit) через компьютерное зрение и навигацию по миникарте. Работаем короткими итерациями, код и правки  только через Codex/код-модель, с обязательным логированием и self-test.

Цель

Надёжный CV-бот, который:

ищет мобов/коробки по основному экрану и миникарте;

сам летает по миникарте (подлёт к целям, переходы через порталы);

умеет FLEE/SAFE, переживает смерть и cooldown по картам;

в перспективе использует логи для самообучения/улучшения тактики.

Архитектура (инварианты)

vision  захват экрана, ROI, детект:

MINIMAP: игрок (перекрёст), красные цели, порталы.

MAIN: мобы (спрайты + имена), бонус-коробки, HUD (HP/Shield, конфиг).

navigation  расчёт движения:

выбор цели на миникарте;

подлёт к цели на ~80% дистанции;

движение к порталам и вход в SAFE.

FSM  состояния:

FARMING, FLEEING, IN_SAFE, COOLDOWN, DEAD.

Политики: подлёт 80%  engage по лейблам; flee по порогам HP/Shield; SAFE/cooldown после смерти.

controls  клики и клавиши:

ЛКМ по миникарте и окну игры;

клавиши: Z/X, Left Shift, A, B, V, CapsLock, Space и т.п.

tools  утилиты:

tools/roi_calibrator (калибровка ROI главного окна и миникарты);

self-test, вспомогательные скрипты (в т.ч. make_handoff).

config/profiles  профили:

ROI (MAIN/MINIMAP), HSV-диапазоны, ignore-зоны, конфиг порталов, пороги flee и т.д.

Публичные интерфейсы модулей не меняем без явного запроса.

Текущее состояние
Инфраструктура

Репозиторий: space-aces-game (локально: D:\space-aces-bot).

Точка входа: run.py с режимами:

--mode test  визуальный тест/отладка CV. В логах строка формата
Test mode: crates=..., mobs=..., mob_labels=..., enemies_mm=..., player_mm=....

--mode bot  основной игровой режим бота.

Логгер space_aces пишет в logs/space_aces.log.

Vision / MINIMAP

Детект красных целей (мобы/NPC/враги) по HSV с:

фильтрами по площади, размеру bbox и отступу от краёв;

ignore-зонами (например, база на 1-1).

Детект порталов по характерным белым маркерам (есть в техплане, частично реализовано).

Детект игрока по перекрёсту (две светлые линии):

реализация есть, но нестабильная: часто player_mm=None;

без стабильного player_mm навигация не может считаться завершённой.

ROI миникарты сохранён в профиле, но после экспериментов нуждается в перекалибровке (roi_calibrator).

Vision / MAIN

Детект имён мобов:

шаблоны имён вида -=[Luminid]=-, .:{Boss Luminid}:.;

HSV-маска красного текста + разбор начала/конца имени;

функция перевода bbox имени в точку клика чуть выше (по телу моба).

Детект бонус-коробок на основном экране есть и проверялся в test-режиме.

Детект HUD:

HP- и Shield-бары (горизонтальные зелёная/синяя полосы);

конфиг корабля (1/2) в окне "Корабль";

на уровне техплана и частично кода; интеграция в FSM._sense ещё не закончена.

Navigation

В src/nav/navigation.py описан базовый контур:

выбор ближайшей цели по enemies_mm;

расчёт точки подлёта (80% до врага от текущего player_mm);

движение по миникарте, отслеживание прилёта по лучу направления/смещению перекрёстия.

Без стабильного player_mm и актуальных ROI навигация пока не даёт гарантированно корректного результата.

FSM

Состояния и их смысл:

FARMING  фарм мобов и бонус-коробок на дружественных картах.

FLEEING  уход при плохом HP/Shield: макрос ShiftACapsLockBV + уход к порталу.

IN_SAFE  восстановление возле портала (SAFE-зона).

COOLDOWN  фарм на безопасных картах после смерти.

DEAD  обработка модалки смерти, Бесплатно  Отремонтировать  возврат.

Реализация:

FARMING частично работает на уровне детектов (цели на миникарте, имена мобов), но цикл подлёт  lock  стрельба пока не замкнут.

FLEE/IN_SAFE/COOLDOWN/DEAD подробно описаны в техплане, кодовая реализация  частично/заглушки.

Процесс разработки

Короткие итерации (по сути спринты внутри одного чата).

Все изменения кода, конфигов, структуры проекта  только через Codex/код-модель:

ассистент формирует промт с конкретными изменениями;

пользователь скармливает промт Codex и запускает тесты;

результаты (логи/скриншоты) возвращаются в чат и формируют следующий шаг.

Каждый значимый шаг сопровождается запуском python run.py --mode test и анализом логов/окон.

Фокус (Next steps)

ROI + player_mm

Запустить tools/roi_calibrator и корректно настроить:

ROI главного окна (MAIN);

ROI миникарты (MINIMAP).

Пересмотреть и упростить детектор перекрёстия игрока:

надёжный поиск по яркости/HSV;

хранение последней успешной позиции (fallback, если кадр шумный).

Definition of Done:

в --mode test player_mm ненулевой на большинстве кадров;

окна MAIN/MINIMAP показывают нужные области без артефактов экран в экране.

Навигация по миникарте (FARMING)

В FARMING:

выбирать ближайшую цель по enemies_mm;

считать точку подлёта (80% расстояния от player_mm до цели);

кликать по миникарте и ждать прилёта;

логировать траектории в trace.csv.

Definition of Done:

в боевом режиме бот стабильно подлетает к целям.

HP/Shield + FLEE/SAFE/COOLDOWN

Дочинить парсер HP/Shield из HUD и интегрировать в FSM._sense.

Реализовать Flee-политику:

пороги по HP/Shield;

макрос ShiftACapsLockBV;

уход к ближайшему подходящему порталу и вход в SAFE-зону.

Ввести рабочие состояния IN_SAFE и COOLDOWN:

фарм на низших картах после смерти;

возврат на более жирные карты после cooldown.

Engage по лейблам и self-test

В FARMING:

после подлёта по миникарте искать имена мобов на MAIN;

кликать чуть выше имени  lock;

выбирать Z/X по карте (1-x).

Self-test:

набор скриншотов и эталонных ответов для детекторов;

метрики Recall/FPR + тайминги цикла.
